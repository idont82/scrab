<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>33m2 예약 현황</title>
  	<meta name="description" content="삼삼엠투 사이트의 예약현황을 간편히 조회할 수 있습니다.">
  	
	<!-- https://getbootstrap.kr/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css" />
	
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
	
	<script src="/js/common.js"></script>

    <!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-HEBVT6ZR0J"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	
	  gtag('config', 'G-HEBVT6ZR0J');
	</script>
    
    <style>
    </style>
</head>

<body>
	
	<div class="container mt-3">
	  	
	  	<div class="row g-3 align-items-center">
			<H2>예약현황 보기</H2>
		</div>
		
	  	<div class="row g-3 align-items-center">
	  		
	  		<div class="col-auto">
	  			<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect01">날짜</label>
					<select id="sel_month" class="form-select" id="inputGroupSelect01">
					</select>
				</div>
				
			</div>
			
		  	<div class="col-auto">
		  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect02">지역</label>
					<select id="sel_area" class="form-select" id="inputGroupSelect02">
						<option value="None">선택...</option>
						<option value="서울" selected>서울</option>
						<option value="경기">경기</option>
						<option value="강남">강남</option>
						<option value="홍대">홍대</option>
						<option value="인천">인천</option>
						<option value="제주도">제주도</option>
						<option value="부산">부산</option>
					</select>
				</div>
			</div>
			<div class="col">
				<span>최근 3개월까지 예약일수를 조회합니다.</span>
			</div>
			<div class="col-auto">
				<span> 최근업데이트 : </span><span id="label_last"></span>
			</div>
		</div>
		
		<div class="row mt-5">
			<table id="myTable" class="display">
			    <thead>
			    </thead>
			    <tbody>
			    </tbody>
			</table>
		</div>
	</div>

  
	
    <script>
    
    $(document).ready(function() {
    	
    	//1) 날짜 담기
    	const currentDate = new Date();
        const recentMonths = $('#sel_month');

        for (let i = 0; i < 3; i++) {
          const month = currentDate.getMonth() - i;
          const year = currentDate.getFullYear();
          const formattedMonth = (month + 1).toString().padStart(2, '0'); // 1자리 월을 2자리로 표시
          const formattedYear = year.toString();

          const dateString = `${formattedYear}_${formattedMonth}`;

          // option 태그 생성
          const option = $('<option>');
          option.val(dateString);
          option.text(`${formattedYear}-${formattedMonth}`);
          recentMonths.append(option);
        }
        
        recentMonths.change(function() {

            var selectedValue = $(this).val();
            //alert('선택된 값: ' + selectedValue);
            select();
        });
        
        
        //2) 지역
        const recentAreas = $('#sel_area');
        recentAreas.change(function() {

            var selectedValue = $(this).val();
            //alert('선택된 값: ' + selectedValue);
            select();
        });
            
        
        //4)조회
        select();
    	
    });
    
    
    select = function(){
	
    	var pArea = $('#sel_area').val();
    	var pMonth = $('#sel_month').val();
		
    	let url = '../json/' +pArea+ '_'+ pMonth +'.json';
    	
    	if(pArea == "None"){
    		url = '../json/' +pArea+'.json';
    	}
    	
    	let columns =[
    		//{ data: null, title : "Num." },
    		{ data: 'rid', title :"RID" },
	        //{ data: 'town' , title : "동/리"},
	        { data: 'room_name' , title : "명칭", 
						render : function(data,type,row,meta){ 
							return "<a  target='_blank' href='" +"https://33m2.co.kr/room/detail/"+row.rid+ "'>"+data+"</a>"
						} 
	        },
	        { data: 'addr_lot' , title :"주소" },
	        { data: 'using_fee', title :"가격" , type:"num" },
	        //{ data: 'last_date', title :"업데이트"  }
	    ]
    	const MONTH_CNT = 3; //3개월
    	let months = [];
    	
    	for(var i=0; i<MONTH_CNT;i++){
    		let now = new Date();
    		let later = new Date( now.setMonth(now.getMonth() + i) );
    		let dateFormat = later.getFullYear() + '-' + ( (later.getMonth()+1) < 9 ? "0" + (later.getMonth()+1) : (later.getMonth()+1) );
    		let dateFormatNm = dateFormat.replaceAll("-","") +"_cnt" ;
    		
    		columns.push( { data: dateFormatNm, title : dateFormat } ); 
    		
    		months.push(dateFormatNm);
		}
    	
    	//SUM
    	columns.push({ title :"예약일수" , type:"num" , render : function(data,type,row,meta){
			return row[months[0]] + row[months[1]] + row[months[2]];
		}});
    	    	
    
	    tableData = $('#myTable').DataTable( {
	    	order: [7, 'desc'],// [[4, 'desc'],[5, 'desc'],[6, 'desc']],
	    	
	    	layout: {
	            topStart: {
	            	buttons: ['excelHtml5'],
	                pageLength: {
	                    menu: [100, 300, 500, 1000, 2000, 3000, 4000, 5000]
	                },
	                
	            },
	        },
	        pageLength: 500,
	        destroy: true,
	    	paging: true,
	        ajax: { url : url, dataSrc : '', 
		        	complete: function (data) {
		    			$('#myTable tbody').on('dblclick', 'tr', function (e) {
		    				const rowData = tableData.row(this).data()
			    			console.log('클릭한 행 데이터', rowData);
		    				//window.open("https://33m2.co.kr/room/detail/"+rowData.rid);
		    			});
		    			
		    			var last = tableData.row(':last').data();
		    			var first = tableData.row(':first').data();
		    			
		    			if(first != null){
		    				label_last.innerText = first["last_date"];
		    			}
		        	}
	        },
		    columns: columns,
		    columnDefs: [
		    	{ targets: 3 , render: $.fn.dataTable.render.number( ',' ) },
		    	//{ targets: 0,  data: null,  render: function (data, type, row, meta) {  return meta.row + 1;  }  }
		      ]
	    } );
	    
	    
	    
    };
    
    </script>
</body>

</html>